<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¶“å…¸æ¥é¾ - èªªæ˜èˆ‡è‡ªå‹•é…å°ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --card-width: 100px;
            --card-height: 145px;
            --bg-color: #2e7d32; 
            --card-radius: 12px;
            --shadow: 0 2px 8px rgba(0,0,0,0.2);
            --font-main: 'Google Sans', 'Inter', sans-serif;
        }

        @media (max-width: 768px) {
            :root {
                --card-width: 13vw;
                --card-height: 19vw;
            }
        }

        body {
            background-color: var(--bg-color);
            font-family: var(--font-main);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            touch-action: none; 
            color: white;
            display: flex;
            flex-direction: column;
        }

        .top-nav {
            background: #1b5e20;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .stats-group { display: flex; gap: 24px; }
        .stat-item { display: flex; align-items: center; gap: 8px; font-size: 0.95rem; font-weight: 500; }

        .game-area {
            flex-grow: 1;
            padding: 20px;
            max-width: 1100px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        .slot {
            width: var(--card-width);
            height: var(--card-height);
            border-radius: var(--card-radius);
            position: relative;
        }

        .slot-placeholder {
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            width: var(--card-width);
            height: var(--card-height);
            background: white;
            border-radius: var(--card-radius);
            position: absolute;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 6px; 
            box-sizing: border-box;
            cursor: grab;
            backface-visibility: hidden;
            overflow: hidden;
            touch-action: none;
        }

        .card.back {
            background: #4285f4;
            background-image: radial-gradient(circle at center, #4285f4 0%, #1a73e8 100%);
            border: 2px solid white;
        }

        .card.red { color: #d93025; fill: #d93025; }
        .card.black { color: #202124; fill: #202124; }

        .card-corner {
            line-height: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 24px;
            pointer-events: none;
        }
        .card-value { font-size: 1.1rem; font-weight: 700; }
        .card-suit-mini { font-size: 0.75rem; margin-top: 1px; }

        /* ä¿®æ­£å³ä¸‹è§’æ•¸å­—åç§»å•é¡Œ */
        .card-corner-bottom {
            transform: rotate(180deg);
            align-self: flex-end;
            margin-bottom: 2px;
            margin-right: 0px;
        }

        .card-main-content {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .card-main-icon { font-size: 2.2rem; }
        .character-icon { width: 60%; height: 60%; }

        .dragging {
            opacity: 0.8 !important;
            z-index: 10000 !important;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4) !important;
            pointer-events: none !important;
            position: fixed !important; 
        }

        /* å½ˆçª—æ¨£å¼ (èªªæ˜èˆ‡å‹åˆ©) */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            color: #333;
            padding: 32px;
            border-radius: 24px;
            max-width: 450px;
            width: 90%;
            text-align: left;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<nav class="top-nav">
    <div class="flex items-center gap-4">
        <span class="text-xl font-bold tracking-tight">Solitaire</span>
        <button class="text-xs bg-white/10 px-3 py-1 rounded-full hover:bg-white/20" onclick="toggleModal('instruction-modal', true)">éŠæˆ²èªªæ˜</button>
    </div>
    <div class="stats-group">
        <div class="stat-item">åˆ†æ•¸: <span id="score">0</span></div>
        <div class="stat-item">æ™‚é–“: <span id="timer">00:00</span></div>
        <div class="stat-item">æ­¥æ•¸: <span id="moves">0</span></div>
    </div>
    <button class="text-sm font-medium hover:opacity-80" onclick="initGame()">é‡æ–°é–‹å§‹</button>
</nav>

<main class="game-area">
    <div class="flex justify-between">
        <div class="flex gap-4">
            <div id="stock" class="slot slot-placeholder cursor-pointer" onclick="drawCard()"></div>
            <div id="waste" class="slot"></div>
        </div>
        <div class="flex gap-4">
            <div id="f-0" class="slot slot-placeholder foundation" data-suit="H"></div>
            <div id="f-1" class="slot slot-placeholder foundation" data-suit="D"></div>
            <div id="f-2" class="slot slot-placeholder foundation" data-suit="C"></div>
            <div id="f-3" class="slot slot-placeholder foundation" data-suit="S"></div>
        </div>
    </div>
    <div id="tableau" class="flex justify-between flex-grow mt-4"></div>
</main>

<!-- éŠæˆ²èªªæ˜å½ˆçª— -->
<div id="instruction-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="text-2xl font-bold mb-4 text-green-800">å¦‚ä½•éŠç©ï¼Ÿ</h2>
        <ul class="space-y-3 text-sm leading-relaxed text-gray-700">
            <li>âœ¨ <b>è‡ªå‹•ç§»å‹•</b>ï¼šåœ¨å¡ç‰Œä¸Šã€Œé›™æ“Šã€ï¼Œç¨‹å¼æœƒè‡ªå‹•å°‡å¡ç‰Œç§»è‡³å³ä¸Šè§’çµç®—å€æˆ–é©åˆçš„æ¥é¾ä½ç½®ã€‚</li>
            <li>ğŸƒ <b>æ¥é¾è¦å‰‡</b>ï¼šå¡ç‰Œå¿…é ˆæŒ‰ã€Œç´…é»‘äº¤æ›¿ã€ä¸”ã€Œæ•¸å€¼éæ¸›ã€æ’åˆ—ï¼ˆä¾‹å¦‚ï¼šé»‘è‰² 8 ä¸‹æ–¹å¯æ¥ç´…è‰² 7ï¼‰ã€‚</li>
            <li>ğŸ† <b>ç›®æ¨™</b>ï¼šå°‡æ‰€æœ‰èŠ±è‰²å¾ A åˆ° K ä¾åºæ”¶é›†åˆ°å³ä¸Šè§’çš„å››å€‹çµç®—å€ã€‚</li>
            <li>ğŸ’¡ <b>æç¤º</b>ï¼šç©ºå‡ºçš„ä½ç½®åªèƒ½æ”¾ç½®åœ‹ç‹ (K)ã€‚</li>
        </ul>
        <button class="mt-8 w-full bg-green-700 text-white py-3 rounded-xl font-bold hover:bg-green-800" onclick="toggleModal('instruction-modal', false)">æˆ‘çŸ¥é“äº†</button>
    </div>
</div>

<!-- å‹åˆ©å½ˆçª— -->
<div id="victory-screen" class="modal-overlay">
    <div class="modal-content text-center">
        <div class="text-5xl mb-4">ğŸ‰</div>
        <h2 class="text-3xl font-bold mb-2">å‹åˆ©ï¼</h2>
        <p id="victory-stats" class="text-gray-600 mb-6"></p>
        <button class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold" onclick="initGame()">å†ç©ä¸€æ¬¡</button>
    </div>
</div>

<script>
    const suits = ['H', 'D', 'C', 'S'];
    const suitIcons = { 'H': 'â™¥', 'D': 'â™¦', 'C': 'â™£', 'S': 'â™ ' };
    const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    
    const charSVGs = {
        'J': `<svg viewBox="0 0 24 24" class="character-icon"><path d="M12 2c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm9 7h-6v13h-2v-6h-2v6H9V9H3V7h18v2z"/></svg>`,
        'Q': `<svg viewBox="0 0 24 24" class="character-icon"><path d="M5 16L3 5l3.5 3.5L12 3l5.5 5.5L21 5l-2 11H5zm14 3c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2v-1h14v1z"/></svg>`,
        'K': `<svg viewBox="0 0 24 24" class="character-icon"><path d="M5 16l-1-8h3l2-3h6l2 3h3l-1 8H5zm14 3c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2v-1h14v1zM12 8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>`
    };

    let deck = [], stock = [], waste = [], foundations = [[],[],[],[]], tableau = [[],[],[],[],[],[],[]];
    let score = 0, moves = 0, time = 0, timerInterval = null;
    let activeDrag = null;

    function toggleModal(id, show) {
        document.getElementById(id).style.display = show ? 'flex' : 'none';
    }

    function initGame() {
        toggleModal('victory-screen', false);
        clearInterval(timerInterval);
        score = 0; moves = 0; time = 0;
        updateStats();
        startTimer();
        
        deck = [];
        suits.forEach(s => values.forEach(v => deck.push({ suit: s, value: v, faceUp: false })));
        deck.sort(() => Math.random() - 0.5);

        for(let i=0; i<7; i++) {
            tableau[i] = [];
            for(let j=0; j<=i; j++) {
                const card = deck.pop();
                if(j === i) card.faceUp = true;
                tableau[i].push(card);
            }
        }
        stock = deck; waste = []; foundations = [[],[],[],[]];
        render();
    }

    function createCardUI(card, source, idx) {
        const el = document.createElement('div');
        el.className = 'card' + (!card.faceUp ? ' back' : (card.suit === 'H' || card.suit === 'D' ? ' red' : ' black'));
        
        if(card.faceUp) {
            const charIcon = charSVGs[card.value] || null;
            el.innerHTML = `
                <div class="card-corner">
                    <span class="card-value">${card.value}</span>
                    <span class="card-suit-mini">${suitIcons[card.suit]}</span>
                </div>
                <div class="card-main-content">
                    ${charIcon ? charIcon : `<div class="card-main-icon">${suitIcons[card.suit]}</div>`}
                </div>
                <div class="card-corner card-corner-bottom">
                    <span class="card-value">${card.value}</span>
                    <span class="card-suit-mini">${suitIcons[card.suit]}</span>
                </div>
            `;
            
            const handleStart = (e) => {
                const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
                startDrag(clientX, clientY, card, source, idx, el);
            };

            el.onmousedown = handleStart;
            el.ontouchstart = (e) => { e.preventDefault(); handleStart(e); };

            // é›™æ“Šè‡ªå‹•ç§»å‹•
            el.ondblclick = (e) => {
                e.stopPropagation();
                autoMove(card, source, idx);
            };
        }
        return el;
    }

    function startDrag(clientX, clientY, card, source, idx, originalEl) {
        if (activeDrag) return;

        let cardsToDrag = [];
        if (source.startsWith('t-')) {
            const colIdx = parseInt(source.split('-')[1]);
            cardsToDrag = tableau[colIdx].slice(idx);
        } else if (source === 'waste') {
            cardsToDrag = [waste[waste.length - 1]];
        } else if (source.startsWith('f-')) {
            cardsToDrag = [foundations[parseInt(source.split('-')[1])].slice(-1)[0]];
        }

        const rect = originalEl.getBoundingClientRect();
        const offsetX = clientX - rect.left;
        const offsetY = clientY - rect.top;

        const dragElements = [];
        cardsToDrag.forEach((c, i) => {
            const clone = createCardUI(c, source, idx + i);
            clone.classList.add('dragging');
            clone.style.width = rect.width + 'px';
            clone.style.height = rect.height + 'px';
            clone.style.left = rect.left + 'px';
            clone.style.top = (rect.top + i * 30) + 'px';
            document.body.appendChild(clone);
            dragElements.push(clone);
        });

        activeDrag = { source, idx, cards: cardsToDrag, elements: dragElements, offsetX, offsetY };

        const onMove = (me) => {
            const mx = me.clientX || (me.touches ? me.touches[0].clientX : 0);
            const my = me.clientY || (me.touches ? me.touches[0].clientY : 0);
            activeDrag.elements.forEach((el, i) => {
                el.style.left = (mx - activeDrag.offsetX) + 'px';
                el.style.top = (my - activeDrag.offsetY + i * 30) + 'px';
            });
        };

        const onEnd = (ee) => {
            const ex = ee.clientX || (ee.changedTouches ? ee.changedTouches[0].clientX : 0);
            const ey = ee.clientY || (ee.changedTouches ? ee.changedTouches[0].clientY : 0);
            window.removeEventListener('mousemove', onMove);
            window.removeEventListener('mouseup', onEnd);
            window.removeEventListener('touchmove', onMove);
            window.removeEventListener('touchend', onEnd);

            checkDrop(ex, ey);
            activeDrag.elements.forEach(el => el.remove());
            activeDrag = null;
        };

        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onEnd);
        window.addEventListener('touchmove', onMove, {passive: false});
        window.addEventListener('touchend', onEnd);
    }

    function checkDrop(x, y) {
        const slots = document.querySelectorAll('.slot');
        let dropTarget = null;
        slots.forEach(s => {
            const r = s.getBoundingClientRect();
            if (x >= r.left - 30 && x <= r.right + 30 && y >= r.top - 30 && y <= r.bottom + 30) {
                dropTarget = s;
            }
        });

        if (dropTarget) {
            const id = dropTarget.id || dropTarget.parentElement.id;
            const tMatch = id.match(/t-(\d+)/);
            const fMatch = id.match(/f-(\d+)/);

            if (tMatch) {
                const colIdx = parseInt(tMatch[1]);
                if (isValidTableauMove(activeDrag.cards[0], tableau[colIdx])) {
                    executeMove(tableau[colIdx]);
                    render(); return;
                }
            } else if (fMatch && activeDrag.cards.length === 1) {
                const fIdx = parseInt(fMatch[1]);
                if (isValidFoundationMove(activeDrag.cards[0], fIdx)) {
                    executeMove(foundations[fIdx]);
                    score += 10;
                    render(); return;
                }
            }
        }
        render();
    }

    function isValidTableauMove(card, list) {
        if (!list.length) return card.value === 'K';
        const top = list[list.length - 1];
        if (!top.faceUp) return false;
        const isRed = (c) => c.suit === 'H' || c.suit === 'D';
        return isRed(card) !== isRed(top) && values.indexOf(card.value) === values.indexOf(top.value) - 1;
    }

    function isValidFoundationMove(card, fIdx) {
        const list = foundations[fIdx];
        if (!list.length) return card.value === 'A' && card.suit === suits[fIdx];
        const top = list[list.length - 1];
        return card.suit === top.suit && values.indexOf(card.value) === values.indexOf(top.value) + 1;
    }

    function executeMove(targetList) {
        const { source, idx, cards } = activeDrag;
        if (source.startsWith('t-')) {
            const col = parseInt(source.split('-')[1]);
            tableau[col].splice(idx);
            if (tableau[col].length && !tableau[col][tableau[col].length - 1].faceUp) {
                tableau[col][tableau[col].length - 1].faceUp = true;
                score += 5;
            }
        } else if (source === 'waste') waste.pop();
        else foundations[parseInt(source.split('-')[1])].pop();

        cards.forEach(c => targetList.push(c));
        moves++; updateStats();
    }

    function render() {
        const stockEl = document.getElementById('stock');
        stockEl.innerHTML = stock.length ? '<div class="card back"></div>' : '<div class="text-2xl opacity-20">â†º</div>';

        const wasteEl = document.getElementById('waste');
        wasteEl.innerHTML = '';
        if(waste.length) wasteEl.appendChild(createCardUI(waste[waste.length-1], 'waste', waste.length-1));

        for(let i=0; i<4; i++) {
            const fEl = document.getElementById(`f-${i}`);
            fEl.innerHTML = '';
            if(foundations[i].length) {
                fEl.appendChild(createCardUI(foundations[i][foundations[i].length-1], `f-${i}`, foundations[i].length-1));
            } else {
                fEl.innerHTML = `<span class="text-3xl opacity-10">${suitIcons[suits[i]]}</span>`;
            }
        }

        const tableauContainer = document.getElementById('tableau');
        tableauContainer.innerHTML = '';
        for(let i=0; i<7; i++) {
            const col = document.createElement('div');
            col.id = `t-${i}`;
            col.className = "slot flex-grow relative";
            tableau[i].forEach((card, j) => {
                const cardEl = createCardUI(card, `t-${i}`, j);
                cardEl.style.top = `${j * (window.innerWidth < 768 ? 15 : 30)}px`;
                col.appendChild(cardEl);
            });
            tableauContainer.appendChild(col);
        }
        checkWin();
    }

    function drawCard() {
        if(!stock.length) {
            stock = waste.reverse().map(c => ({...c, faceUp: false}));
            waste = [];
        } else {
            waste.push({...stock.pop(), faceUp: true});
        }
        moves++; updateStats(); render();
    }

    function autoMove(card, source, idx) {
        let isLastCard = false;
        if (source.startsWith('t-')) {
            const col = parseInt(source.split('-')[1]);
            if (idx === tableau[col].length - 1) isLastCard = true;
        } else if (source === 'waste') isLastCard = true;

        if (isLastCard) {
            for(let i=0; i<4; i++) {
                if(isValidFoundationMove(card, i)) {
                    activeDrag = { source, idx, cards: [card] };
                    executeMove(foundations[i]);
                    score += 10; render(); return;
                }
            }
        }

        for(let i=0; i<7; i++) {
            if (source === `t-${i}`) continue;
            if(isValidTableauMove(card, tableau[i])) {
                let cardsToMove = [card];
                if (source.startsWith('t-')) {
                    const fromCol = parseInt(source.split('-')[1]);
                    cardsToMove = tableau[fromCol].slice(idx);
                }
                activeDrag = { source, idx, cards: cardsToMove };
                executeMove(tableau[i]);
                render(); return;
            }
        }
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            time++;
            const m = Math.floor(time / 60).toString().padStart(2, '0');
            const s = (time % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    function updateStats() {
        document.getElementById('score').innerText = score;
        document.getElementById('moves').innerText = moves;
    }

    function checkWin() {
        if(foundations.every(f => f.length === 13)) {
            clearInterval(timerInterval);
            document.getElementById('victory-stats').innerText = `æ­¥æ•¸: ${moves} | æ™‚é–“: ${document.getElementById('timer').innerText}`;
            toggleModal('victory-screen', true);
        }
    }
    window.onload = initGame;
</script>
</body>
</html>
